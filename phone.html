<!DOCTYPE html>
<html>
  <head>
    <title>Phone controls</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="node_modules/socket.io/client-dist/socket.io.js"></script>
    <script src="js/adapter.js"></script>
  </head>
  <body>
      <h1>Select this vehicle</h1>
      <select name="vehicle" id="vehicle">
          <option label=" "></option>
          <option value="FELA">Front End Loader A</option>
          <option value="FELB">Front End Loader B</option>
          <option value="DMPA">Dump Truck A</option>
          <option value="DMPB">Dump Truck B</option>
          <option value="EXCA">Excavator A</option>
          <option value="EXCB">Excavator B</option>
      </select>
      <script>
          // import adapter from 'webrtc-adapter';

          vehicle = document.getElementById("vehicle");
          vehicle.style.display = 'none'; // hide it

          vehicle.addEventListener("change", open_connection);

          var server = window.location.protocol + '//' + window.location.host;
          var socket = io(server);

          var peer_id;
          var peer_server_id;
          var peer = new Peer();
          var ready = 0;

          socket.on('connect', () => {
              socket.on('new-peer-server-id', (server_id) => {
                  console.log('got a peer server update via socketio ')
                  peer_server_id = server_id;
                  ready += 1;
                  if ( ready >= 2 ) { vehicle.style.display = 'block'; }
              })
              peer.on('open', function(id) {
                  console.log('made peer connection')
                  peer_id = id;
                  ready += 1;
                  if ( ready >= 2 ) { vehicle.style.display = 'block'; }
              });
          });

          function open_connection() {
              var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
              getUserMedia({video: true, audio: false}, function(stream) {
                  var call = peer.call(peer_server_id, stream, { metadata: { vehicle: vehicle.value } });
              }, function(err) {
                  console.log('Failed to get local stream' ,err);
              });
            }
      </script>
  </body>
</html>
